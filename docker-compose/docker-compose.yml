services:
  
  heartbeat:
    build:
      context: .
      dockerfile: Dockerfile.heartbeat
    container_name: heartbeat
    networks:
      - soft-cep-network
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - KIBANA_HOST=http://kibana:5601
    healthcheck:
      test: [ "CMD-SHELL", "heartbeat test config | grep -q 'Config OK'" ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
  
  elasticsearch:
    networks:
      - soft-cep-network
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:9200/_cluster/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  kibana:
    networks:
      - soft-cep-network
    image: docker.elastic.co/kibana/kibana:8.15.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:5601/api/status | grep -q '\"All services and plugins are available\"'"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  apm-server:
    networks:
      - soft-cep-network
    image: docker.elastic.co/apm/apm-server:8.15.0
    container_name: apm-server
    cap_add: ["CHOWN", "DAC_OVERRIDE", "SETGID", "SETUID"]
    cap_drop: ["ALL"]
    ports:
      - 8200:8200
    command: >
      apm-server -e
        -E apm-server.rum.enabled=true
        -E setup.kibana.host=kibana:5601
        -E setup.template.settings.index.number_of_replicas=0
        -E apm-server.kibana.enabled=true
        -E apm-server.kibana.host=kibana:5601
        -E output.elasticsearch.hosts=["elasticsearch:9200"]
    healthcheck:
      interval: 10s
      retries: 12
      test: ["CMD-SHELL", "! apm-server test output | grep -q ERROR" ]
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy
  
  redis:
    image: "redis:latest"
    container_name: redis-cache
    ports:
      - "6379:6379"
    networks:
      - soft-cep-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping | grep PONG" ]
      interval: 1s
      timeout: 3s
      retries: 5


  app:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: soft-cep-app
    depends_on:
      redis:
        condition: service_healthy
      kibana:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      apm-server:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ASPNETCORE_URLS: "http://+:8080"
      ConnectionStrings__Redis: "redis-cache:6379"
      Infrastructure__ViaCep__BaseUrl: "https://viacep.com.br/ws/"
    ports:
      - "8080:8080"
    networks:
      - soft-cep-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  soft-cep-network:
    driver: bridge
